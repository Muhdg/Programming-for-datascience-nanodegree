/* Query 1 - the query used for the first insight */
WITH T1 AS
(SELECT
	F.TITLE TITLE,
	C.NAME CATEGORY,
	R.RENTAL_ID
FROM CATEGORY C
JOIN FILM_CATEGORY FC ON C.CATEGORY_ID = FC.CATEGORY_ID
JOIN FILM F ON FC.FILM_ID = F.FILM_ID
JOIN INVENTORY I ON F.FILM_ID = I.FILM_ID
JOIN RENTAL R ON I.INVENTORY_ID = R.INVENTORY_ID)

SELECT 
	DISTINCT TITLE, 
	CATEGORY,
	COUNT(RENTAL_ID) OVER (PARTITION BY TITLE)
FROM T1
WHERE CATEGORY IN ('Animation', 'Children', 'Classics', 'Comedy', 'Family', 'Music')
ORDER BY 2,1


/* Query 2 - the query used for the third insight */
WITH T1 AS
(SELECT
	F.TITLE,
	C.NAME,
	F.RENTAL_DURATION,
	NTILE(4) OVER (ORDER BY F.RENTAL_DURATION) STANDARD_QUARTILE
FROM FILM F
JOIN FILM_CATEGORY FC ON F.FILM_ID = FC.FILM_ID
JOIN CATEGORY C ON FC.CATEGORY_ID = C.CATEGORY_ID
WHERE NAME IN ('Animation', 'Children', 'Classics', 'Comedy', 'Family', 'Music'))

SELECT
	NAME,
	STANDARD_QUARTILE,
	COUNT(*)
FROM T1
GROUP BY 1,2
ORDER BY 1,2


/* Query 3 - the query used for the fourth insight */
SELECT
	S.STORE_ID,
	DATE_PART('YEAR',R.RENTAL_DATE) RENTAL_YEAR,
	DATE_PART('MONTH', R.RENTAL_DATE) RENTAL_MONTH,
	COUNT(R.RENTAL_ID)
FROM STORE S
JOIN STAFF STF ON S.STORE_ID = STF.STORE_ID
JOIN PAYMENT P ON STF.STAFF_ID = P.STAFF_ID
JOIN RENTAL R ON P.RENTAL_ID = R.RENTAL_ID
GROUP BY 1,2,3
ORDER BY 4 DESC


/* Query 4 - the query used for the fifth insight */
SELECT *
FROM
	(SELECT  
		C.FIRST_NAME || ' ' || C.LAST_NAME AS FULL_NAME,
		DATE_TRUNC('MONTH', P.PAYMENT_DATE) PAYMENT_MONTH,
		COUNT(P.AMOUNT) NUM_OF_PAYMENTS,
		SUM(P.AMOUNT) AMT_PAID
	FROM CUSTOMER C
	JOIN PAYMENT P ON C.CUSTOMER_ID = P.CUSTOMER_ID
	WHERE C.FIRST_NAME || ' ' || C.LAST_NAME IN
	(SELECT
		T1.FULL_NAME
FROM
	(SELECT 
		C.FIRST_NAME || ' ' || C.LAST_NAME AS FULL_NAME,
		SUM(P.AMOUNT) AMT_PAID
	FROM CUSTOMER C
	JOIN PAYMENT P ON C.CUSTOMER_ID = P.CUSTOMER_ID
	GROUP BY 1
	ORDER BY 2 DESC
	LIMIT 10) T1)	
GROUP BY 1,2) T2
WHERE PAYMENT_MONTH BETWEEN '2007-01-01' AND '2008-01-01'
ORDER BY 1, 2